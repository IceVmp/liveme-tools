<!doctype html>
<html>
	<head>
		<title>Download Queue</title>
		<link rel="stylesheet" href="style/style.css">

		<script>
			if (typeof module === 'object') {window.module = module; module = undefined;} 
		</script>
		
		<script src="javascript/jquery-3.2.1.min.js"></script>
		<script type="text/javascript">
			const { ipcRenderer, remote } = require('electron'), Downloader = remote.getGlobal('Downloader');

			$(function() {
				Downloader.events.on('add', (arg) => {
					$('#queuelist').append(`
						<div class="item small" id="${arg.id}">
							<div class="content">
								<div style="display: inline-block; width: 572px; text-overflow: ellipsis; overflow: hidden; line-height: 28px">
									${arg.value}
								</div>
								<div style="display: inline-block; text-align: right;">
									<a class="button icon icon-remove float-right" onClick="remove('${arg.id}')"></a>
								</div>
							</div>
						</div>
					`);
				});

				Downloader.events.on('fail', (arg) => {
					$('#' + arg.id).addClass("error");
					$('.progress .bar').css({ width: '0%' });
					$('.active_url').html('&nbsp;');

					setTimeout(() => {
						$('#' + arg.id).slideUp(400).remove();
                    }, 4000);
                    
                    $('#cancelActiveButton').hide();
				});

				Downloader.events.on('clear-queue', () => {
					$('#queuelist').empty();
				});

				Downloader.events.on('progress', (arg) => {
					$('.progress .bar').css({ width: arg.value + '%' });
					$('.active_url').html(arg.url);
				});

				Downloader.events.on('start', (arg) => {
					$('#' + arg.id).remove();
					$('.progress .bar').css({ width: '0%' });
                    $('.active_url').html(arg.url);
                    $('#cancelActiveButton').show();
				});

				Downloader.events.on('finish', (arg) => {
					$('#' + arg.id).addClass("finished");
					$('.progress .bar').css({ width: '0%' });
					$('.active_url').html('&nbsp;');

					setTimeout(() => {
						$('#' + arg.id).slideUp(400).remove();
                    }, 4000);
                    
                    $('#cancelActiveButton').hide();
				});

				Downloader.events.on('resume', () => {
					$('a.button.icon-play').removeClass('icon-play').addClass('icon-pause');
				});

				Downloader.events.on('pause', () => {
					$('a.button.icon-pause').removeClass('icon-pause').addClass('icon-play');
				});

				Downloader.events.on('remove', (arg) => {
					$('#' + arg.id).remove();
				});
			});

			function pauseResume() {
				if (!Downloader.isPaused()) {
					Downloader.pause();
				} else {
					Downloader.resume();
				}
			}

			function remove(vid) {
				Downloader.remove(vid);
            }
            
            function killDownload() {
                Downloader.killActiveDownload();
            }

			function hideQueue() {
				ipcRenderer.send('hide-queue');
			}

			function addSingleURL() {
				var u = $('#url').val();

				$('overlay').hide();
				$('#prompt1').hide();

				if (u != null) {
					Downloader.add({
						user: {
							id: null,
							name: null
						},
						video: {
							id: new Date().getUTCMilliseconds(), // We need an ID, doesn't need to be real.
							title: null,
							time: 0,
							url: u.trim()
						}
					});
					$('#url').val('');
				}
			}

			function showURLPrompt() {
				$('overlay').show();
				$('#prompt1').show().focus();
			}

			function hideURLPrompt() {
				$('overlay').hide();
				$('#prompt1').hide();
			}

			function emptyQueue() {
				$('overlay').show();
				$('#prompt2').show();
			}

			function emptyQueueYes() {
				Downloader.purgeQueue();
				hideEmptyPrompt();
			}

			function hideEmptyPrompt() {
				$('overlay').hide(200);
				$('#prompt2').hide(200);
			}
		</script>

	</head>
	<body>
		<overlay></overlay>
		<toolbar>
			<div class="section width48">
				<a class="button icon icon-pause" onClick="pauseResume()"></a>
			</div>
			<div class="section with-progress-bar width520">
				<label class="active_url">&nbsp;</label>
				<div class="progress"><div class="bar"></div></div>				
			</div>
			<div class="section width48 align-right">
				<a id="cancelActiveButton" class="button icon icon-cancel" style="display: none;" onClick="killDownload()"></a>
			</div>
		</toolbar>

		<main class="offset48 with-footer">
			<div id="queuelist" class="list"></div>
		</main>

		<footer class="align-right">
			<input type="button" class="tiny" value="Add URL" class="tiny" onClick="showURLPrompt()">
			<input type="button" class="tiny" value="Empty Queue" class="tiny" onClick="emptyQueue()">
		</footer>

		
		<div id="prompt1" class="modal small">
			<div class="content">
				Enter the URL you would like to add to the download queue:
				<input type="text" id="url" style="width: 425px; margin-top: 8px">

				<div class="buttons">
					<input type="button" value="Add URL" onClick="addSingleURL()">
					&nbsp;&nbsp;&nbsp;&nbsp;
					<input type="button" value="Cancel" onClick="hideURLPrompt()">
				</div>
			</div>
		</div>


		<div id="prompt2" class="modal tiny">
			<div class="content">
				Confirm removal of all items currently in the download queue.
				<div class="buttons">
					<input type="button" value="Yes, empty it!" onClick="emptyQueueYes()">
					&nbsp;&nbsp;&nbsp;&nbsp;
					<input type="button" value="No, don't do it!" onClick="hideEmptyPrompt()">
				</div>
			</div>
		</div>

		
	</body>
</html>